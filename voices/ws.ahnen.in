# Websockets Proxy to Python Server

map $http_upgrade $connection_upgrade {
		default upgrade;
		'' close;
}

server {
	#listen 8765;
	#	listen 443;
	server_name ws.ahnen.in;
	listen 443 ssl; # managed by Certbot
    	ssl_certificate /etc/letsencrypt/live/ws.ahnen.in/fullchain.pem; # managed by Certbot
    	ssl_certificate_key /etc/letsencrypt/live/ws.ahnen.in/privkey.pem; # managed by Certbot
    	include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    	ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


	location / {
		# Redirect all traffic to 127.0.0.1:8001
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header Host $host;
		proxy_pass http://websocket;

		# Websocket support
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection $connection_upgrade;

	}
}

# Here's the websocket server list (could do load balancing here)
upstream websocket {
	# WS server is running on localhost port 8001
	server 127.0.0.1:8001;
}
